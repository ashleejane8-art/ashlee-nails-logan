<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ashlee Nails — Admin</title>

  <!-- Netlify Identity Widget (required for Netlify Identity login) -->
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <style>
    :root{
      --bg: #0b0d12;
      --surface: rgba(255,255,255,.06);
      --surface2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --border: rgba(255,255,255,.12);
      --accent: #9173ff;
      --accent2: #ffbb7d;
      --good: #2ecc71;
      --warn: #f39c12;
      --bad: #e74c3c;
      --shadow: 0 12px 38px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 26px;
      --focus: 0 0 0 3px rgba(255,255,255,.18), 0 0 0 6px rgba(145,115,255,.22);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 800px at 30% -10%, rgba(124,92,255,.20), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(46,204,113,.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 64px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;background: var(--surface2);border: 1px solid var(--border);
      border-radius: var(--radius);box-shadow: var(--shadow);backdrop-filter: blur(10px);
      position:sticky;top:10px;z-index:20;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, var(--accent), rgba(145,115,255,.35));
      border: 1px solid var(--border);
    }
    .title{font-weight:980;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border: 1px solid var(--border);background: var(--surface);font-size:12px;color:var(--muted);
      max-width: 100%;
    }
    .pill strong{color:var(--text);font-weight:980}
    .btn{
      appearance:none;border: 1px solid var(--border);background: var(--surface);
      color:var(--text);padding:10px 12px;border-radius: 14px;cursor:pointer;
      font-weight:950;font-size:13px;line-height:1;transition:.15s;
    }
    .btn:hover{transform: translateY(-1px);border-color: rgba(145,115,255,.65)}
    .btn.primary{background: linear-gradient(135deg, var(--accent), var(--accent2)); border-color: var(--border); color: rgba(0,0,0,.88)}
    .btn.danger{background: rgba(231,76,60,.14);border-color: rgba(231,76,60,.35)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .panel{
      margin-top:16px;
      border: 1px solid var(--border);background: var(--surface);border-radius: var(--radius);
      box-shadow: var(--shadow);backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panel-h{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--surface2), transparent);
    }
    .panel-h .h{font-weight:1000;letter-spacing:.2px}
    .panel-h .meta{font-size:12px;color:var(--muted)}
    .controls{
      display:grid;
      grid-template-columns: 1.2fr .7fr .7fr auto auto;
      gap:10px;
      padding:12px 14px;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:10px 10px;border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      color:var(--text);
      outline:none;
      font-family: var(--font);
    }
    textarea{min-height:92px;resize:vertical}
    input::placeholder{color: rgba(167,173,189,.7)}
    .error{
      border:1px solid rgba(231,76,60,.45);
      background: rgba(231,76,60,.12);
      color: #ffecec;
      padding: 10px 12px;border-radius: 14px;
      margin: 12px 14px 0;
      display:none;
      white-space: pre-wrap;
    }
    .error .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .error .msg{white-space: pre-wrap}
    .error .actions{display:flex;gap:8px;flex-wrap:wrap}

    /* Table */
    .table-wrap{width:100%;overflow:auto;border-top:1px solid var(--border)}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1120px}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{
      position:sticky;top:0;background: var(--surface);backdrop-filter: blur(10px);
      text-align:left;font-size:12px;color:var(--muted);font-weight:980;z-index:5;
    }
    td{font-size:13px}
    .muted{color:var(--muted)}
    .small{font-size:12px;color:var(--muted);margin-top:4px}
    .status{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border: 1px solid var(--border);
      background: var(--surface);font-size:12px;color:var(--text);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .dot.new{background: var(--accent)}
    .dot.contacted{background: var(--warn)}
    .dot.booked{background: var(--good)}
    .dot.closed{background: var(--surface)}
    .dot.noshow{background: var(--bad)}
    .cell-actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:10px;font-size:12px;font-weight:980}
    .mini.primary{background: rgba(124,92,255,.18);border-color: rgba(124,92,255,.55)}
    .mini.good{background: rgba(46,204,113,.12);border-color: rgba(46,204,113,.35)}
    .mini.warn{background: rgba(243,156,18,.12);border-color: rgba(243,156,18,.35)}
    .mini.bad{background: rgba(231,76,60,.12);border-color: rgba(231,76,60,.35)}

    details{
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 14px;
      padding: 8px 10px;
      width:100%;
      max-width: 520px;
    }
    summary{
      cursor:pointer;
      list-style:none;
      font-weight:980;
      color: var(--text);
      font-size: 12px;
    }
    summary::-webkit-details-marker{display:none}
    .admin-edit{
      margin-top:10px;
      display:grid;
      gap:10px;
    }
    .admin-row{display:grid;gap:6px}
    .help{font-size:12px;color:var(--muted)}
    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius: 14px;border: 1px solid var(--border);
      background: var(--surface);
    }
    .toggle input{width:auto;transform: scale(1.1)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border: 1px solid var(--border);
      background: var(--surface);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .badge strong{color:var(--text)}
    .badge.archived{
      border-color: rgba(255,255,255,.18);
      background: var(--surface);
    }

    /* Mobile cards */
    .cards{display:none;padding:12px 14px;gap:12px}
    .card{
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      padding: 12px;
    }
    .card-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .card-title{font-weight:1000}
    .kv{display:grid;grid-template-columns: 140px 1fr;gap:8px 10px;margin-top:10px}
    .k{color:var(--muted);font-size:12px}
    .v{font-size:13px;word-break:break-word}
    .card-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background: var(--surface);border: 1px solid var(--border);color:var(--text);
      padding:10px 12px;border-radius: 14px;box-shadow: var(--shadow);display:none;
      max-width: calc(100% - 24px);z-index:60;
    }

    @media (max-width: 980px){
      .controls{grid-template-columns: 1fr 1fr 1fr;}
    }
    @media (max-width: 860px){
      header{top:8px}
      .controls{grid-template-columns: 1fr 1fr;}
    }
    @media (max-width: 720px){
      .controls{grid-template-columns: 1fr;}
      .table-wrap{display:none}
      .cards{display:grid}
      table{min-width:0}
      details{max-width: 100%;}
      .kv{grid-template-columns: 120px 1fr;}
    }
  
    /* Fixed clinic booking phone */
    .clinic-fixed{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 80;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: calc(100% - 32px);
    }
    .clinic-fixed .label{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .clinic-fixed .phone{
      font-weight:980;
      color: var(--text);
      white-space:nowrap;
    }
    .clinic-fixed .copy{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:980;
    }
    @media (max-width: 720px){
      .clinic-fixed{
        left: 12px;
        right: 12px;
        bottom: 12px;
        justify-content: space-between;
      }
      .clinic-fixed .label{display:none;}
    }

  
    /* Focus ring */
    button:focus-visible,
    .btn:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible,
    summary:focus-visible {
      outline: none;
      box-shadow: var(--focus);
    }

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Ashlee Nails — Admin</div>
          <div class="sub">Leads dashboard (Netlify Identity required)</div>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="authPill">
          Status: <strong id="authStatus">Checking…</strong>
        </div>
        <button class="btn primary" id="btnLogin">Log in</button>
        <button class="btn primary" id="btnRelogin" style="display:none;">Re-login</button>
        <button class="btn" id="btnRefresh" disabled>Refresh</button>
        <button class="btn" id="btnExport" disabled>Export CSV</button>
        <button class="btn danger" id="btnLogout" disabled>Log out</button>
      </div>
    </header>

    <section class="panel">
      <div class="panel-h">
        <div>
          <div class="h">Leads</div>
          <div class="meta" id="metaLine">—</div>
        </div>
        <div class="meta" id="metaCounts"></div>
      </div>

      <div class="error" id="errorBox"></div>

      <div class="controls">
        <div class="field">
          <label for="q">Search</label>
          <input id="q" type="text" placeholder="Name, IG, notes, service…" disabled />
        </div>

        <div class="field">
          <label for="statusFilter">Status</label>
          <select id="statusFilter" disabled>
            <option value="all">All</option>
            <option value="new">New</option>
            <option value="contacted">Contacted</option>
            <option value="booked">Booked</option>
            <option value="closed">Closed</option>
            <option value="noshow">No-show</option>
          </select>
        </div>

        <div class="field">
          <label for="archivedFilter">Archived</label>
          <select id="archivedFilter" disabled>
            <option value="active">Active</option>
            <option value="archived">Archived</option>
            <option value="all">All</option>
          </select>
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <button class="btn" id="btnClear" disabled>Clear filters</button>
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <button class="btn primary" id="btnIdentity">Open Identity</button>
        </div>
      </div>

      <!-- Desktop table view -->
      <div class="table-wrap" aria-label="Leads table">
        <table>
          <thead>
            <tr>
              <th style="min-width:170px;">Created / Updated</th>
              <th style="min-width:190px;">Name</th>
              <th style="min-width:220px;">IG / Contact</th>
              <th style="min-width:180px;">Service / Availability</th>
              <th style="min-width:260px;">Notes</th>
              <th style="min-width:210px;">Status</th>
              <th style="min-width:520px;">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="muted" colspan="7">Please log in.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Mobile card view -->
      <div class="cards" id="cards" aria-label="Leads cards"></div>
    </section>
  </div>

  <!-- Fixed clinic booking phone -->
  <div class="clinic-fixed" role="group" aria-label="Clinic booking phone">
    <div>
      <div class="label">Clinic booking phone</div>
      <div class="phone" id="clinicPhone">(435) 752-3599</div>
    </div>
    <a class="btn copy" id="btnClinicDirections" href="https://www.google.com/maps/search/?api=1&query=Paul%20Mitchell%20The%20School%20Logan%2C%20185%20E%201250%20N%20Ste.%20200%2C%20Logan%2C%20UT%2084341" target="_blank" rel="noopener">Directions</a>
    <button class="btn copy" id="btnClinicCopy" type="button">Copy</button>
  </div>


  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function () {
      // Do not change auth or endpoints.
      const API_LIST = "/.netlify/functions/leads-list";
      const API_UPDATE = "/.netlify/functions/leads-update";
      const STATUS_OPTIONS = ["new","contacted","booked","closed","noshow"];

      const el = (id) => document.getElementById(id);

      const authStatus = el("authStatus");
      const btnLogin = el("btnLogin");
      const btnRelogin = el("btnRelogin");
      const btnLogout = el("btnLogout");
      const btnRefresh = el("btnRefresh");
      const btnExport = el("btnExport");
      const btnClear = el("btnClear");
      const btnIdentity = el("btnIdentity");

      const q = el("q");
      const statusFilter = el("statusFilter");
      const archivedFilter = el("archivedFilter");

      const metaLine = el("metaLine");
      const metaCounts = el("metaCounts");
      const errorBox = el("errorBox");

      const tbody = el("tbody");
      const cards = el("cards");
      const toast = el("toast");

      // Fixed clinic phone copy
      const clinicPhoneText = "(435) 752-3599";
      const btnClinicCopy = document.getElementById("btnClinicCopy");
      if (btnClinicCopy) {
        btnClinicCopy.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(clinicPhoneText);
            showToast("Clinic phone copied.");
          } catch {
            // fallback
            const ta = document.createElement("textarea");
            ta.value = clinicPhoneText;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand("copy"); showToast("Clinic phone copied."); }
            catch { showToast("Copy failed."); }
            finally { document.body.removeChild(ta); }
          }
        });
      }


      let currentUser = null;
      let allLeads = [];
      let filteredLeads = [];

      // Dirty tracking to prevent data loss
      const dirtyById = new Map(); // id -> true/false

      function anyDirty() {
        for (const v of dirtyById.values()) if (v) return true;
        return false;
      }

      function setDirty(id, isDirty) {
        if (!id) return;
        dirtyById.set(id, !!isDirty);
      }

      window.addEventListener("beforeunload", (e) => {
        if (anyDirty()) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      function confirmDiscardIfDirty() {
        if (!anyDirty()) return true;
        return confirm("You have unsaved edits (internal notes/tags/archived). Discard and continue?");
      }

      function showToast(message) {
        toast.textContent = message;
        toast.style.display = "block";
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => (toast.style.display = "none"), 2200);
      }

      function showError(message, opts) {
        const options = opts || {};
        errorBox.style.display = "block";
        const showRelogin = !!options.showRelogin;
        errorBox.innerHTML = `
          <div class="row">
            <div class="msg">${escapeHtml(message)}</div>
            <div class="actions">
              ${showRelogin ? `<button class="btn primary mini" id="errRelogin">Re-login</button>` : ``}
              <button class="btn mini" id="errDismiss">Dismiss</button>
            </div>
          </div>
        `;
        const dismiss = document.getElementById("errDismiss");
        if (dismiss) dismiss.addEventListener("click", clearError);
        const rel = document.getElementById("errRelogin");
        if (rel) rel.addEventListener("click", () => openRelogin());
      }

      function clearError() {
        errorBox.style.display = "none";
        errorBox.textContent = "";
      }

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function safeStr(v) {
        if (v === null || v === undefined) return "";
        return String(v);
      }

      function toISODate(v) {
        try {
          const d = (typeof v === "number") ? new Date(v) : new Date(v);
          if (isNaN(d.getTime())) return "";
          return d.toISOString();
        } catch { return ""; }
      }

      function formatLocalDate(v) {
        const iso = toISODate(v);
        if (!iso) return "";
        const d = new Date(iso);
        return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }

      function parseTags(input) {
        const s = safeStr(input);
        if (!s.trim()) return [];
        return s.split(",").map(t => t.trim()).filter(Boolean);
      }

      function tagsToString(tags) {
        if (!tags) return "";
        if (Array.isArray(tags)) return tags.join(", ");
        return safeStr(tags);
      }

      // Contract mapping:
      // {
      //   id, created_at, updated_at, status, suggested_dm, internal_notes, tags, archived,
      //   lead: { name, phone, instagram, service, availability, notes, contact_preference, budget?, length?, style? }
      // }
      function normalizeLead(raw) {
        const r = raw || {};
        const l = r.lead || {};
        const status = (r.status || "new").toLowerCase();

        return {
          id: r.id || "",
          created_at: r.created_at || "",
          updated_at: r.updated_at || "",
          status: STATUS_OPTIONS.includes(status) ? status : "new",
          suggested_dm: r.suggested_dm || "",
          internal_notes: r.internal_notes || "",
          tags: Array.isArray(r.tags) ? r.tags : [],
          archived: !!r.archived,

          name: l.name || "",
          ig: l.instagram || "",
          phone: l.phone || "",
          email: l.email || "",
          service: l.service || "",
          availability: l.availability || "",
          contact_preference: l.contact_preference || "",
          notes: l.notes || "",

          // Optional display fields (only if present)
          budget: l.budget || "",
          length: l.length || "",
          style: l.style || ""
        };
      }

      function statusDotClass(status) {
        const s = (status || "new").toLowerCase();
        return STATUS_OPTIONS.includes(s) ? s : "new";
      }

      function setAuthedUI(isAuthed) {
        authStatus.textContent = isAuthed ? "Signed in" : "Signed out";
        btnLogin.disabled = isAuthed;
        btnLogout.disabled = !isAuthed;
        btnRefresh.disabled = !isAuthed;
        btnExport.disabled = !isAuthed || !filteredLeads.length;
        q.disabled = !isAuthed;
        statusFilter.disabled = !isAuthed;
        archivedFilter.disabled = !isAuthed;
        btnClear.disabled = !isAuthed;
      }

      function setReloginVisible(v) {
        btnRelogin.style.display = v ? "inline-flex" : "none";
      }

      function renderCounts() {
        const total = allLeads.length;
        const shown = filteredLeads.length;
        metaLine.textContent = currentUser
          ? `Signed in as ${safeStr(currentUser.user_metadata?.full_name || currentUser.email || "User")}`
          : "Not signed in";
        metaCounts.textContent = total ? `${shown} shown / ${total} total` : "0 leads";
      }

      function applyFilters() {
        const query = q.value.trim().toLowerCase();
        const sFilter = statusFilter.value;
        const aFilter = archivedFilter.value;

        filteredLeads = allLeads.filter(l => {
          // Requirement: search across name/IG/notes/service
          const hay = [l.name, l.ig, l.notes, l.service].map(safeStr).join(" ").toLowerCase();
          const okQuery = !query || hay.includes(query);
          const okStatus = (sFilter === "all") || (safeStr(l.status).toLowerCase() === sFilter);

          const isArchived = !!l.archived;
          const okArchived =
            (aFilter === "all") ||
            (aFilter === "active" && !isArchived) ||
            (aFilter === "archived" && isArchived);

          return okQuery && okStatus && okArchived;
        });

        btnClear.disabled =
          (!q.value && statusFilter.value === "all" && archivedFilter.value === "active") || !currentUser;
        btnExport.disabled = !currentUser || !filteredLeads.length;

        renderLeads();
        renderCounts();
      }

      async function getJWT() {
        if (!currentUser) throw new Error("Not authenticated.");
        return await currentUser.jwt();
      }

      function openRelogin() {
        setReloginVisible(false);
        if (window.netlifyIdentity) window.netlifyIdentity.open("login");
      }

      function handleAuthFailure(statusCode, context) {
        const code = Number(statusCode || 0);
        if (code === 401 || code === 403) {
          setReloginVisible(true);
          showError(`${context} failed (${code}). Your session may have expired. Please re-login.`, { showRelogin: true });
          return true;
        }
        return false;
      }

      async function apiPatchLead(id, patch) {
        clearError();

        if (!safeStr(id)) {
          showToast("Missing lead ID.");
          return { ok: false };
        }

        const token = await getJWT();

        const res = await fetch(API_UPDATE, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ id, patch })
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          if (handleAuthFailure(res.status, "Update")) return { ok: false, auth: true };
          throw new Error(`Update failed (${res.status}). ${txt}`.trim());
        }
        return { ok: true };
      }

      function makeCopyButton(label, text) {
        const b = document.createElement("button");
        b.className = "btn mini";
        b.textContent = label;
        b.addEventListener("click", async () => {
          const msg = safeStr(text).trim();
          if (!msg) return showToast("Nothing to copy.");
          try {
            await navigator.clipboard.writeText(msg);
            showToast("Copied.");
          } catch {
            const ta = document.createElement("textarea");
            ta.value = msg;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand("copy"); showToast("Copied."); }
            catch { showToast("Copy failed."); }
            finally { document.body.removeChild(ta); }
          }
        });
        return b;
      }

      function makeMarkButton(label, status, cls) {
        const b = document.createElement("button");
        b.className = `btn mini ${cls || ""}`.trim();
        b.textContent = label;
        b.addEventListener("click", async (e) => {
          // no-op; actual handler set by caller (lead context)
        });
        b.dataset.markStatus = status;
        return b;
      }

      function makeStatusSelect(lead) {
        const sel = document.createElement("select");
        sel.style.minWidth = "140px";
        STATUS_OPTIONS.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s.charAt(0).toUpperCase() + s.slice(1);
          if (s === lead.status) opt.selected = true;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", async () => {
          try {
            const newStatus = sel.value;
            await updateLeadStatus(lead, newStatus);
          } catch {}
        });
        return sel;
      }

      async function updateLeadStatus(lead, newStatus) {
        if (!lead || !safeStr(lead.id)) return showToast("Missing lead ID.");
        if (!STATUS_OPTIONS.includes(newStatus)) return showToast("Invalid status.");

        try {
          const out = await apiPatchLead(lead.id, { status: newStatus });
          if (!out.ok) return;
          lead.status = newStatus;
          applyFilters();
          showToast("Status updated.");
        } catch (err) {
          showError(err.message || String(err));
        }
      }

      async function updateLeadAdmin(lead, internalNotes, tagsArr, archived, maybeStatus) {
        if (!lead || !safeStr(lead.id)) return showToast("Missing lead ID.");
        const patch = {
          internal_notes: safeStr(internalNotes),
          tags: Array.isArray(tagsArr) ? tagsArr : [],
          archived: !!archived
        };
        if (maybeStatus && STATUS_OPTIONS.includes(maybeStatus)) {
          patch.status = maybeStatus;
        }

        try {
          const out = await apiPatchLead(lead.id, patch);
          if (!out.ok) return;

          lead.internal_notes = safeStr(internalNotes);
          lead.tags = Array.isArray(tagsArr) ? tagsArr : [];
          lead.archived = !!archived;
          if (patch.status) lead.status = patch.status;

          setDirty(lead.id, false);
          applyFilters();
          showToast("Saved.");
        } catch (err) {
          showError(err.message || String(err));
        }
      }

      function makeAdminEditor(lead) {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.textContent = "Admin (internal notes / tags / archived)";
        details.appendChild(summary);

        const wrap = document.createElement("div");
        wrap.className = "admin-edit";

        // Internal notes
        const rowNotes = document.createElement("div");
        rowNotes.className = "admin-row";
        const notesLabel = document.createElement("div");
        notesLabel.className = "help";
        notesLabel.textContent = "Internal notes (private)";
        const ta = document.createElement("textarea");
        ta.value = safeStr(lead.internal_notes);
        ta.addEventListener("input", () => setDirty(lead.id, true));
        rowNotes.appendChild(notesLabel);
        rowNotes.appendChild(ta);

        // Tags
        const rowTags = document.createElement("div");
        rowTags.className = "admin-row";
        const tagsLabel = document.createElement("div");
        tagsLabel.className = "help";
        tagsLabel.textContent = "Tags (comma-separated)";
        const tagsInput = document.createElement("input");
        tagsInput.placeholder = "vip, referral, follow-up";
        tagsInput.value = tagsToString(lead.tags);
        tagsInput.addEventListener("input", () => setDirty(lead.id, true));
        rowTags.appendChild(tagsLabel);
        rowTags.appendChild(tagsInput);

        // Archived toggle
        const rowArch = document.createElement("div");
        rowArch.className = "admin-row";
        const archLabel = document.createElement("div");
        archLabel.className = "help";
        archLabel.textContent = "Archived";
        const archWrap = document.createElement("label");
        archWrap.className = "toggle";
        const arch = document.createElement("input");
        arch.type = "checkbox";
        arch.checked = !!lead.archived;
        arch.addEventListener("change", () => setDirty(lead.id, true));
        const archTxt = document.createElement("div");
        archTxt.innerHTML = `<div><strong>${lead.archived ? "Archived" : "Active"}</strong></div><div class="help">Archived leads are hidden when Archived filter is set to Active.</div>`;
        arch.addEventListener("change", () => {
          archTxt.querySelector("strong").textContent = arch.checked ? "Archived" : "Active";
        });
        archWrap.appendChild(arch);
        archWrap.appendChild(archTxt);

        rowArch.appendChild(archLabel);
        rowArch.appendChild(archWrap);

        // Actions
        const actions = document.createElement("div");
        actions.className = "cell-actions";

        const saveBtn = document.createElement("button");
        saveBtn.className = "btn mini primary";
        saveBtn.textContent = "Save";

        saveBtn.addEventListener("click", async () => {
          saveBtn.disabled = true;
          try {
            const nextNotes = ta.value;
            const nextTags = parseTags(tagsInput.value);
            const nextArchived = arch.checked;
            await updateLeadAdmin(lead, nextNotes, nextTags, nextArchived, null);
            // sync fields
            ta.value = safeStr(lead.internal_notes);
            tagsInput.value = tagsToString(lead.tags);
            arch.checked = !!lead.archived;
          } finally {
            saveBtn.disabled = false;
          }
        });

        actions.appendChild(saveBtn);

        wrap.appendChild(rowNotes);
        wrap.appendChild(rowTags);
        wrap.appendChild(rowArch);
        wrap.appendChild(actions);

        details.appendChild(wrap);
        return details;
      }

      function renderLeads() {
        tbody.innerHTML = "";
        cards.innerHTML = "";

        if (!currentUser) {
          tbody.innerHTML = `<tr><td class="muted" colspan="7">Please log in.</td></tr>`;
          cards.innerHTML = "";
          return;
        }

        if (!filteredLeads.length) {
          tbody.innerHTML = `<tr><td class="muted" colspan="7">No leads match your filters.</td></tr>`;
          cards.innerHTML = `<div class="muted">No leads match your filters.</div>`;
          return;
        }

        for (const lead of filteredLeads) {
          // Desktop row
          const tr = document.createElement("tr");

          const tdCreated = document.createElement("td");
          const createdLine = formatLocalDate(lead.created_at) || "—";
          const updatedLine = lead.updated_at ? (formatLocalDate(lead.updated_at) || "") : "";
          tdCreated.innerHTML = `
            <div>${createdLine}</div>
            <div class="small">${updatedLine ? ("Updated: " + escapeHtml(updatedLine)) : ""}</div>
            <div class="small">${safeStr(lead.id) ? ("ID: " + escapeHtml(lead.id)) : ""}</div>
          `;

          const tdName = document.createElement("td");
          tdName.innerHTML = `
            <div style="font-weight:1000;">${safeStr(lead.name) ? escapeHtml(lead.name) : "<span class='muted'>—</span>"}</div>
            ${lead.archived ? `<div class="badge archived" style="margin-top:8px;"><strong>Archived</strong></div>` : ``}
          `;

          const tdContact = document.createElement("td");
          const igRaw = safeStr(lead.ig);
          const igHandle = igRaw ? igRaw.replace(/^@/,"") : "";
          const igLine = igHandle ? `@${escapeHtml(igHandle)}` : "";
          const phoneLine = safeStr(lead.phone);
          const emailLine = safeStr(lead.email);
          tdContact.innerHTML =
            `<div>${igLine || "<span class='muted'>—</span>"}</div>
             <div class="small">${escapeHtml(phoneLine || "")}${(phoneLine && emailLine) ? " • " : ""}${escapeHtml(emailLine || "")}</div>`;

          const tdService = document.createElement("td");
          const extraBits = [];
          if (lead.availability) extraBits.push(`Availability: ${escapeHtml(lead.availability)}`);
          if (lead.contact_preference) extraBits.push(`Contact pref: ${escapeHtml(lead.contact_preference)}`);
          if (lead.budget) extraBits.push(`Budget: ${escapeHtml(lead.budget)}`);
          if (lead.length) extraBits.push(`Length: ${escapeHtml(lead.length)}`);
          if (lead.style) extraBits.push(`Style: ${escapeHtml(lead.style)}`);

          tdService.innerHTML = `
            <div>${safeStr(lead.service) ? escapeHtml(lead.service) : "—"}</div>
            ${extraBits.length ? `<div class="small">${extraBits.join("<br/>")}</div>` : ``}
          `;

          const tdNotes = document.createElement("td");
          tdNotes.innerHTML = `<div>${safeStr(lead.notes) ? escapeHtml(lead.notes) : "<span class='muted'>—</span>"}</div>`;

          const tdStatus = document.createElement("td");
          const statusWrap = document.createElement("div");
          statusWrap.className = "status";
          statusWrap.innerHTML = `<span class="dot ${statusDotClass(lead.status)}"></span>
                                  <span>${escapeHtml((safeStr(lead.status) || "new").toUpperCase())}</span>`;
          tdStatus.appendChild(statusWrap);
          tdStatus.appendChild(document.createElement("div")).style.height = "8px";
          const statusSel = makeStatusSelect(lead);
          tdStatus.appendChild(statusSel);

          const tdActions = document.createElement("td");

          // Quick actions row
          const actions = document.createElement("div");
          actions.className = "cell-actions";

          actions.appendChild(makeCopyButton("Copy suggested DM", lead.suggested_dm));
          actions.appendChild(makeCopyButton("Copy phone", lead.phone));
          actions.appendChild(makeCopyButton("Copy IG", igHandle ? `@${igHandle}` : ""));

          const igBtn = document.createElement("a");
          igBtn.className = "btn mini";
          igBtn.textContent = "Open IG";
          if (igHandle) {
            igBtn.href = `https://www.instagram.com/${encodeURIComponent(igHandle)}/`;
            igBtn.target = "_blank";
            igBtn.rel = "noopener noreferrer";
          } else {
            igBtn.href = "javascript:void(0)";
            igBtn.addEventListener("click", (e) => { e.preventDefault(); showToast("No IG handle."); });
          }
          actions.appendChild(igBtn);

          // One-click status buttons
          const btnContacted = document.createElement("button");
          btnContacted.className = "btn mini warn";
          btnContacted.textContent = "Mark Contacted";
          btnContacted.addEventListener("click", async () => updateLeadStatus(lead, "contacted"));

          const btnBooked = document.createElement("button");
          btnBooked.className = "btn mini good";
          btnBooked.textContent = "Mark Booked";
          btnBooked.addEventListener("click", async () => updateLeadStatus(lead, "booked"));

          const btnClosed = document.createElement("button");
          btnClosed.className = "btn mini";
          btnClosed.textContent = "Mark Closed";
          btnClosed.addEventListener("click", async () => updateLeadStatus(lead, "closed"));

          actions.appendChild(btnContacted);
          actions.appendChild(btnBooked);
          actions.appendChild(btnClosed);

          tdActions.appendChild(actions);
          tdActions.appendChild(document.createElement("div")).style.height = "10px";
          tdActions.appendChild(makeAdminEditor(lead));

          tr.appendChild(tdCreated);
          tr.appendChild(tdName);
          tr.appendChild(tdContact);
          tr.appendChild(tdService);
          tr.appendChild(tdNotes);
          tr.appendChild(tdStatus);
          tr.appendChild(tdActions);
          tbody.appendChild(tr);

          // Mobile card
          const card = document.createElement("div");
          card.className = "card";

          const top = document.createElement("div");
          top.className = "card-top";
          top.innerHTML = `
            <div>
              <div class="card-title">${safeStr(lead.name) ? escapeHtml(lead.name) : "—"}</div>
              <div class="small" style="margin-top:2px;">Created: ${escapeHtml(createdLine)}</div>
              ${lead.updated_at ? `<div class="small">Updated: ${escapeHtml(updatedLine || "")}</div>` : ``}
            </div>
            <div style="display:grid;gap:8px;justify-items:end;">
              <div class="status">
                <span class="dot ${statusDotClass(lead.status)}"></span>
                <span>${escapeHtml((safeStr(lead.status) || "new").toUpperCase())}</span>
              </div>
              ${lead.archived ? `<div class="badge archived"><strong>Archived</strong></div>` : ``}
            </div>
          `;

          const kv = document.createElement("div");
          kv.className = "kv";
          kv.innerHTML = `
            <div class="k">IG</div><div class="v">${igLine || "—"}</div>
            <div class="k">Phone</div><div class="v">${escapeHtml(phoneLine || "—")}</div>
            <div class="k">Email</div><div class="v">${escapeHtml(emailLine || "—")}</div>
            <div class="k">Service</div><div class="v">${escapeHtml(lead.service || "—")}</div>
            <div class="k">Availability</div><div class="v">${escapeHtml(lead.availability || "—")}</div>
            <div class="k">Contact pref</div><div class="v">${escapeHtml(lead.contact_preference || "—")}</div>
            ${lead.budget ? `<div class="k">Budget</div><div class="v">${escapeHtml(lead.budget)}</div>` : ``}
            ${lead.length ? `<div class="k">Length</div><div class="v">${escapeHtml(lead.length)}</div>` : ``}
            ${lead.style ? `<div class="k">Style</div><div class="v">${escapeHtml(lead.style)}</div>` : ``}
            <div class="k">Notes</div><div class="v">${escapeHtml(lead.notes || "—")}</div>
            <div class="k">ID</div><div class="v">${escapeHtml(lead.id || "—")}</div>
          `;

          const cardActions = document.createElement("div");
          cardActions.className = "card-actions";

          cardActions.appendChild(makeCopyButton("Copy suggested DM", lead.suggested_dm));
          cardActions.appendChild(makeCopyButton("Copy phone", lead.phone));
          cardActions.appendChild(makeCopyButton("Copy IG", igHandle ? `@${igHandle}` : ""));

          const openIgBtn = document.createElement("a");
          openIgBtn.className = "btn mini";
          openIgBtn.textContent = "Open IG";
          if (igHandle) {
            openIgBtn.href = `https://www.instagram.com/${encodeURIComponent(igHandle)}/`;
            openIgBtn.target = "_blank";
            openIgBtn.rel = "noopener noreferrer";
          } else {
            openIgBtn.href = "javascript:void(0)";
            openIgBtn.addEventListener("click", (e) => { e.preventDefault(); showToast("No IG handle."); });
          }
          cardActions.appendChild(openIgBtn);

          const stWrap = document.createElement("div");
          stWrap.className = "card-actions";
          const m1 = document.createElement("button");
          m1.className = "btn mini warn";
          m1.textContent = "Mark Contacted";
          m1.addEventListener("click", async () => updateLeadStatus(lead, "contacted"));
          const m2 = document.createElement("button");
          m2.className = "btn mini good";
          m2.textContent = "Mark Booked";
          m2.addEventListener("click", async () => updateLeadStatus(lead, "booked"));
          const m3 = document.createElement("button");
          m3.className = "btn mini";
          m3.textContent = "Mark Closed";
          m3.addEventListener("click", async () => updateLeadStatus(lead, "closed"));
          stWrap.appendChild(m1); stWrap.appendChild(m2); stWrap.appendChild(m3);

          const adminBlock = makeAdminEditor(lead);
          adminBlock.style.marginTop = "12px";

          card.appendChild(top);
          card.appendChild(kv);
          card.appendChild(cardActions);
          card.appendChild(stWrap);
          card.appendChild(adminBlock);

          cards.appendChild(card);
        }
      }

      async function fetchLeads() {
        clearError();
        setReloginVisible(false);
        btnRefresh.disabled = true;
        btnExport.disabled = true;

        try {
          const token = await getJWT();
          const res = await fetch(API_LIST, {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
          });

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            if (handleAuthFailure(res.status, "Leads fetch")) return;
            throw new Error(`Leads fetch failed (${res.status}). ${txt}`.trim());
          }

          const data = await res.json();
          const list = Array.isArray(data) ? data : (data.leads || data.items || []);
          allLeads = list.map(normalizeLead);

          // Sort newest first
          allLeads.sort((a,b) => {
            const da = new Date(toISODate(a.created_at) || 0).getTime();
            const db = new Date(toISODate(b.created_at) || 0).getTime();
            return db - da;
          });

          // Reset dirty flags (fresh load)
          dirtyById.clear();

          applyFilters();
          showToast("Leads loaded.");
        } catch (err) {
          showError(err.message || String(err));
          tbody.innerHTML = `<tr><td class="muted" colspan="7">Failed to load leads.</td></tr>`;
          cards.innerHTML = `<div class="muted">Failed to load leads.</div>`;
        } finally {
          btnRefresh.disabled = false;
          btnExport.disabled = !currentUser || !filteredLeads.length;
        }
      }

      function exportCSV() {
        if (!filteredLeads.length) return showToast("Nothing to export.");

        const cols = [
          "id","created_at","updated_at",
          "archived","status",
          "name","ig","phone","email",
          "service","availability","contact_preference",
          "budget","length","style",
          "notes","suggested_dm",
          "internal_notes","tags"
        ];

        const esc = (v) => {
          const s = safeStr(v).replace(/\r?\n/g, " ").trim();
          if (/[",]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
          return s;
        };

        const lines = [];
        lines.push(cols.join(","));
        for (const l of filteredLeads) {
          const row = Object.assign({}, l, {
            archived: l.archived ? "true" : "false",
            tags: Array.isArray(l.tags) ? l.tags.join("|") : ""
          });
          lines.push(cols.map(c => esc(row[c])).join(","));
        }

        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ashlee-leads-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("CSV exported.");
      }

      // Netlify Identity
      function initIdentity() {
        if (!window.netlifyIdentity) {
          let tries = 0;
          const t = setInterval(() => {
            tries++;
            if (window.netlifyIdentity) {
              clearInterval(t);
              initIdentity();
            } else if (tries > 50) {
              clearInterval(t);
              showError("Netlify Identity widget failed to load.");
              authStatus.textContent = "Identity unavailable";
              setAuthedUI(false);
            }
          }, 100);
          return;
        }

        window.netlifyIdentity.init();

        currentUser = window.netlifyIdentity.currentUser();
        if (!currentUser) {
          setAuthedUI(false);
          setReloginVisible(false);
          tbody.innerHTML = `<tr><td class="muted" colspan="7">Please log in.</td></tr>`;
          cards.innerHTML = "";
          renderCounts();
        } else {
          setAuthedUI(true);
          renderCounts();
          fetchLeads();
        }

        window.netlifyIdentity.on("login", (user) => {
          currentUser = user;
          setAuthedUI(true);
          setReloginVisible(false);
          renderCounts();
          fetchLeads();
          window.netlifyIdentity.close();
        });

        window.netlifyIdentity.on("logout", () => {
          currentUser = null;
          allLeads = [];
          filteredLeads = [];
          dirtyById.clear();
          setAuthedUI(false);
          setReloginVisible(false);
          tbody.innerHTML = `<tr><td class="muted" colspan="7">Logged out.</td></tr>`;
          cards.innerHTML = "";
          renderCounts();
        });
      }

      // UI events
      btnLogin.addEventListener("click", () => window.netlifyIdentity && window.netlifyIdentity.open("login"));
      btnRelogin.addEventListener("click", () => openRelogin());

      btnLogout.addEventListener("click", () => {
        if (!confirmDiscardIfDirty()) return;
        window.netlifyIdentity && window.netlifyIdentity.logout();
      });

      btnRefresh.addEventListener("click", () => {
        if (!confirmDiscardIfDirty()) return;
        fetchLeads();
      });

      btnExport.addEventListener("click", exportCSV);

      btnClear.addEventListener("click", () => {
        q.value = "";
        statusFilter.value = "all";
        archivedFilter.value = "active";
        applyFilters();
      });

      btnIdentity.addEventListener("click", () => window.netlifyIdentity && window.netlifyIdentity.open());

      q.addEventListener("input", applyFilters);
      statusFilter.addEventListener("change", applyFilters);
      archivedFilter.addEventListener("change", applyFilters);

      // Boot
      authStatus.textContent = "Checking…";
      setAuthedUI(false);
      setReloginVisible(false);
      initIdentity();
    })();
  </script>
</body>
</html>
